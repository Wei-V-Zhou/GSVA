# Clear the environment
rm(list = ls())
gc()
options(stringsAsFactors = FALSE)

# Load libraries
{
  library(GSVA)
  library(dplyr)
  library(Seurat)
  library(cowplot)
  library(pheatmap)
  library(GSEABase)
  library(tidyverse)
  library(reticulate)
}

if(!file.exists("m4T1.cluster_marker.featurecounts.RData")){
  # Load data
  load("m4T1.new.featurecounts.RData")
  
  # Find cluster biomarker
  scset.markers <- FindAllMarkers(scset, only.pos = TRUE, min.pct = 0.25, logfc.threshold = 0.25)
  scset.markers %>% group_by(cluster) %>% top_n(n = 2, wt = avg_logFC)
  # Check the cluster biomarker
  FeaturePlot(scset, features = c("Krt8", "Ngp", "Cd79a", "Pld4", "Hba-a1", "Abcg4"), pt.size = 0.8)
  # Recheck the cluster biomarker
  FeaturePlot(scset, features = c("Cd19", "Cd68", "Ly6g", "Sdc4"), pt.size = 0.8)
  # Save data
  save(scset, scset.markers, file = "m4T1.cluster_marker.featurecounts.RData")
}
load("m4T1.cluster_marker.featurecounts.RData")

# Read Hallmark Gene Sets, please obtain it from original authors' website: MSigDB
hm.sets <- getGmt("h.all.v7.0.symbols.gmt")
row.names(scset@assays[["RNA"]]@counts) <- toupper(rownames(scset@assays[["RNA"]]@counts))

# Get the GSVA signaling pathway
datasets.hm <- gsva(as.matrix(scset@assays[["RNA"]]@counts), hm.sets, method="gsva")
rownames(datasets.hm) <- gsub("HALLMARK_","",rownames(datasets.hm))
scset@assays[["RNA"]]@data <- rbind(scset@assays[["RNA"]]@data, datasets.hm)

# Find the up_expression clusters of signaling pathway
Features <- c("KRAS_SIGNALING_UP", "KRAS_SIGNALING_DN", "ANGIOGENESIS", "P53_PATHWAY", "INFLAMMATORY_RESPONSE",
              "OXIDATIVE_PHOSPHORYLATION", "FATTY_ACID_METABOLISM",  "EPITHELIAL_MESENCHYMAL_TRANSITION",
              "IL6_JAK_STAT3_SIGNALING", "TGF_BETA_SIGNALING", "HYPOXIA", "NOTCH_SIGNALING")
FeaturePlot(scset, Features, cols = c("green", "blue"))
features = c( "MYC_TARGETS_V1", "MYC_TARGETS_V2", "E2F_TARGETS", 
             "MTORC1_SIGNALING", "PI3K_AKT_MTOR_SIGNALING", "PROTEIN_SECRETION",
             "WNT_BETA_CATENIN_SIGNALING", "INTERFERON_ALPHA_RESPONSE", "INTERFERON_GAMMA_RESPONSE")
FeaturePlot(scset, features, cols = c("green", "blue"))
fea <- c("INTERFERON_GAMMA_RESPONSE","INTERFERON_ALPHA_RESPONSE")
FeaturePlot(scset, fea, cols = c("green", "blue"))
features = c("KRAS_SIGNALING_UP", "KRAS_SIGNALING_DN", "ANGIOGENESIS", "P53_PATHWAY",
             "OXIDATIVE_PHOSPHORYLATION", "FATTY_ACID_METABOLISM", "INFLAMMATORY_RESPONSE",
             "EPITHELIAL_MESENCHYMAL_TRANSITION", "MYC_TARGETS_V1", "MYC_TARGETS_V2", "E2F_TARGETS",
             "MTORC1_SIGNALING", "PI3K_AKT_MTOR_SIGNALING", "UNFOLDED_PROTEIN_RESPONSE",
             "HEDGEHOG_SIGNALING", "WNT_BETA_CATENIN_SIGNALING", "INTERFERON_ALPHA_RESPONSE", "INTERFERON_GAMMA_RESPONSE",
             "PROTEIN_SECRETION", "IL6_JAK_STAT3_SIGNALING", "TGF_BETA_SIGNALING", "HYPOXIA", "NOTCH_SIGNALING")

{
  FeaturePlot(scset, features = c( "Hba-a1", "Car2","Abcg4", "Hbb-bt", "Hba-a2",
                                  "Rhd", "Alas2", "Tfrc"), pt.size = 0.8)
# {# tgf-beta
# FeaturePlot(scset, features = c("Tgfbr1", "Smad7", "Tgfb1", "Cdh1"))
# # angiogenesis
# FeaturePlot(scset, features = c("Vcan", "Cd34", "Pecam1", "Postn", "Fstl1"))
# # kras_up_expression
# FeaturePlot(scset, features = c("KRAS_SIGNALING_UP"))
# # kras_down_expression
# FeaturePlot(scset, features = c("Sptbn2", "Fgfr3"))
# # myc
# FeaturePlot(scset, features = c("Pcna", "Psmd7"))
# # ER early
# FeaturePlot(scset, features = c("Aurka"))
# # Notch siganaling
# FeaturePlot(scset, features = c("Jag1", "Notch3", "Notch2", "Notch1"))
# # Interferon response
# FeaturePlot(scset, features = c("Stat1"))
# 
# 
# TGF_BETA_SIGNALING <- c("TGFBR1	SMAD7	TGFB1	SMURF2	SMURF1	BMPR2	SKIL	SKI	ACVR1	PMEPA1	NCOR2	SERPINE1	JUNB	SMAD1	SMAD6	PPP1R15A	TGIF1	FURIN	SMAD3	FKBP1A	MAP3K7	BMPR1A	CTNNB1	HIPK2	KLF10	BMP2	ENG	APC	PPM1A	XIAP	CDH1	ID1	LEFTY2	CDKN1C	TRIM33	RAB31	TJP1	SLC20A1	CDK9	ID3	NOG	ARID4B	IFNGR2	ID2	PPP1CA	SPTBN1	WWTR1	BCAR3	THBS1	FNTA")
# NOTCH_SIGNALING <- c("JAG1	NOTCH3	NOTCH2	APH1A	HES1	CCND1	FZD1	PSEN2	FZD7	DTX1	DLL1	FZD5	MAML2	NOTCH1	PSENEN	WNT5A	CUL1	WNT2	DTX4	SAP30	PPARD	KAT2A	HEYL	SKP1	RBX1	TCF7L2	ARRB1	LFNG	PRKCA	DTX2	ST3GAL6	FBXW11")
# APOPTOSIS <- c("CASP3	CASP9	DFFA	CASP7	CFLAR	BIRC3	PMAIP1	CASP8	JUN	BCL2L11	MCL1	IL1B	SPTAN1	DIABLO	BAX	BIK	IL1A	BID	CDKN1A	GADD45A	DDIT3	CDKN1B	TNF	GSN	TNFSF10	CASP6	SQSTM1	FASLG	EGR3	CD44	FAS	IL18	IGFBP6	PRF1	DAP	CCND1	BTG3	F2R	SATB1	BNIP3L	CASP4	TNFRSF12A	CREBBP	RHOB	GPX3	PDGFRB	TSPO	CCND2	XIAP	TIMP1")
# NOTCH_SIGNALING <- c("JAG1	NOTCH3	NOTCH2	APH1A	HES1	CCND1	FZD1	PSEN2	FZD7	DTX1	DLL1	FZD5	MAML2	NOTCH1	PSENEN	WNT5A	CUL1	WNT2	DTX4	SAP30	PPARD	KAT2A	HEYL	SKP1	RBX1	TCF7L2	ARRB1	LFNG	PRKCA	DTX2	ST3GAL6	FBXW11")
# ESTROGEN_RESPONSE_EARLY <- c("GREB1	CA12	SLC9A3R1	MYB	ANXA9	IGFBP4	SYBU	NPY1R	PDZK1	NRIP1	MLPH	HSPB8	EGR3	KRT19	LRIG1	KDM4B	PGR	RHOBTB3	TPD52L1	ELOVL2	RET	TPBG	TFF1	MAPT	SCNN1A	ABAT	FLNB	XBP1	CELSR2	RAB31	MYBL1	MREG	FAM102A	MSMB	STC2	RETREG1	SIAH2	ZNF185	SLC19A2	SLC1A4	FHL2	BCL2	PMAIP1	AREG	OVOL2	TSKU	ADCY9	RASGRP1	MUC1	KAZN")
# PROTEIN_SECRETION <- c("ARCN1	TMED10	COPB2	RAB14	ATP7A	COPB1	LAMP2	EGFR	IGF2R	COPE	PPT1	AP3S1	BET1	CLCN3	AP2S1	CLTC	AP2M1	RER1	KIF1B	ARF1	OCRL	ICA1	MON2	ARFGEF2	TMED2	NAPG	TMX1	PAM	SCAMP1	SH3GL2	RAB2A	COG2	VAMP3	ERGIC3	DOP1A	VAMP4	VPS4B	NAPA	GNAS	STX7	SEC22B	VPS45	STX16	YKT6	SNX2	ARFGEF1	CLTA	CLN5	M6PR	SGMS1")
# INTERFERON_ALPHA_RESPONSE <- c("MX1	ISG15	AC004551.1	IFIT3	IFI44	IFI35	IRF7	RSAD2	IFI44L	IFITM1	IFI27	IRF9	OASL	EIF2AK2	IFIT2	CXCL10	TAP1	SP110	DDX60	UBE2L6	USP18	PSMB8	IFIH1	BST2	LGALS3BP	ADAR	ISG20	GBP2	IRF1	PLSCR1	PSMB9	HERC6	SAMD9	CMPK2	IFITM3	RTP4	STAT2	SAMD9L	LY6E	IFITM2	HELZ2	CXCL11	TRIM21	PARP14	TRIM26	PARP12	NMI	RNF31	HLA-C	CASP1")
# INTERFERON_GAMMA_RESPONSE <- c("STAT1	ISG15	IFIT1	MX1	IFIT3	IFI35	IRF7	IFIT2	OAS2	TAP1	EIF2AK2	RSAD2	MX2	IRF1	OAS3	TNFSF10	IRF9	CXCL10	IFI44	BST2	XAF1	SP110	OASL	PSMB8	IFI44L	IFITM3	DDX60	LGALS3BP	GBP4	IRF8	PSMB9	PML	IFIH1	UBE2L6	IFI27	ADAR	LY6E	STAT2	CXCL9	IL10RA	PLA2G4A	TRIM21	USP18	PTGS2	EPSTI1	C1S	DDX58	IL15	NLRC5	NMI")
# PI3K_AKT_MTOR_SIGNALING <- c("MAPK8	PIK3R3	GRB2	NFKBIB	MAP2K6	MAPK9	AKT1	MAPK1	PLCG1	TRIB3	GSK3B	MAP2K3	CDKN1A	RAC1	RIPK1	AKT1S1	ACTR2	PRKAR2A	YWHAB	HRAS	PDK1	PIKFYVE	TBK1	ACTR3	E2F1	MYD88	ITPR2	SQSTM1	RPS6KA1	PTPN11	MAPKAP1	PLCB1	RAF1	CAMK4	RPTOR	CFL1	CDK4	TRAF2	GNGT1	UBE2N	ADCY2	CDKN1B	VAV3	FGF6	ECSIT	RALB	ARF1	MKNK1	CDK1	PTEN")
# MTORC1_SIGNALING <- c("FADS1	DDIT4	CALR	HK2	PGK1	SLC7A5	CTSC	ACSL3	SLC1A5	M6PR	TFRC	DDIT3	TMEM97	IFRD1	PLOD2	TUBA4A	PSAT1	CORO1A	LDHA	MTHFD2	FADS2	VLDLR	WARS	SCD	P4HA1	ACTR2	IDH1	SLC2A1	GBE1	SERPINH1	NUPR1	PSMG1	PSPH	NAMPT	CDKN1A	BHLHE40	HSPA9	HSPA5	EGLN3	LGMN	PNP	XBP1	SLA	DDX39A	HSPE1	ACLY	SLC7A11	SSR1	GLA	SQSTM1")
# E2F_TARGETS <- c("AURKA	BRCA2	CCP110	CENPE	CKS2	DCLRE1B	DNMT1	DONSON	EED	GINS1	GINS4	H2AFZ	LIG1	MAD2L1	MCM2	MCM4	MCM5	MCM7	MELK	MMS22L	NAA38	NASP	NUDT21	NUP205	ORC6	PCNA	PLK4	POLE	PRIM2	RAD51AP1	RFC2	RPA2	RPA3	SUV39H1	TMPO	UBE2T	WDR90	CDK1	MCM3	TOP2A	MCM6	BIRC5	CCNB2	RRM2	HMGB2	BUB1B	RFC3	EZH2	CHEK1	SMC4")
# MYC_TARGETS_V1 <- c("PCNA	PSMD8	PSMD7	SET	SNRPA1	RAN	SRSF2	G3BP1	STARD7	NPM1	BUB3	EIF3D	XPO1	FBL	EIF4A1	CANX	NAP1L1	CBX3	CCT3	C1QBP	U2AF1	UBE2L3	SSBP1	SRSF1	TCP1	MCM2	EIF3B	PSMD14	SNRPA	PWP1	APEX1	TXNL4A	HNRNPR	PSMB2	HPRT1	MCM6	NME1	SNRPD1	EEF1B2	HSPD1	CAD	RPL18	PGK1	DDX18	RPS2	LDHA	RUVBL2	RNPS1	EIF2S1	RANBP1")
# MYC_TARGETS_V2 <- c("SLC19A1	MRTO4	TMEM97	RRP9	PES1	TFB2M	EXOSC5	IPO4	NDUFAF4	NOC4L	MYC	SRM	PA2G4	GNL3	NOLC1	WDR43	RABEPK	NOP16	TBRG4	DDX18	NIP7	WDR74	BYSL	HSPD1	PLK4	NOP2	PPAN	NOP56	RCL1	NPM1	AIMP2	RRP12	PPRC1	TCOF1	MCM5	HK2	CBX3	PLK1	PHB	MCM4	CDK4	DUSP2	MYBBP1A	UTP20	PRMT3	FARSA	MAP3K6	LAS1L	PUS1	HSPE1")
# EPITHELIAL_MESENCHYMAL_TRANSITION <- c("COL3A1	COL5A2	COL5A1	FBN1	COL1A1	FN1	COL6A3	SERPINE1	COL1A2	COL4A1	COL4A2	VCAN	IGFBP3	TGFBI	SPARC	LUM	LAMC1	LOX	LAMC2	CCN2	TAGLN	COL7A1	LOXL2	COL6A2	ITGAV	THBS2	COL16A1	NNMT	TPM1	CDH2	MMP2	COL11A1	THBS1	FAP	BGN	SERPINH1	FSTL1	POSTN	THY1	SPP1	TNC	TFPI2	NID2	ITGB5	MMP3	VIM	LOXL1	FBLN5	COL12A1	ELN")
# INFLAMMATORY_RESPONSE <- c("CXCL10	CCL2	CCL5	FPR1	CCL20	IL1A	CXCL8	CCL7	CCL22	CXCL11	CCR7	EDN1	CD40	CXCL9	IL6	IL1B	TLR2	IL1R1	CD69	ICAM1	CCRL2	AQP9	EREG	C3AR1	GNA15	CMKLR1	PTGER4	LIF	IL15	NAMPT	OPRK1	ITGB8	PTAFR	ADM	PLAUR	NFKB1	INHBA	OSM	TNFSF10	TNFSF15	IFNGR2	ADGRE1	IL12B	CSF1	CXCL6	TNFRSF9	LYN	ACVR2A	LDLR	BDKRB1")
# P53_PATHWAY <- c("CDKN1A	BTG2	MDM2	CCNG1	FAS	TOB1	GADD45A	PHLDA3	TAP1	CDKN2B	SFN	ZMAT3	DDB2	EI24	PERP	DDIT4	ATF3	BAX	SESN1	FDXR	PIDD1	SAT1	CDKN2A	AEN	PPM1D	FOXO3	BTG1	TXNIP	SLC19A2	IER3	TP53	NOTCH1	RRAD	DCXR	NINJ1	FOS	S100A10	FBXW7	PLK3	XPC	AK1	TRIAP1	BAK1	CCND2	APAF1	PDGFA	NDRG1	RALGDS	SERPINB5	DGKA")
# ANGIOGENESIS <- c("VCAN	POSTN	FSTL1	LRPAP1	STC1	LPL	VEGFA	PF4	THBD	FGFR1	TNFRSF21	CCND2	COL5A2	ITGAV	SERPINA5	KCNJ8	APP	JAG1	COL3A1	SPP1	NRP1	OLR1	PDGFA	PTK2	SLCO2A1	PGLYRP1	VAV2	S100A4	MSX1	VTN	TIMP1	APOH	PRG2	JAG2	LUM	CXCL6")
# KRAS_SIGNALING_UP <- c("ANGPTL4	ITGA2	SPRY2	HBEGF	RBP4	HSD11B1	ETV4	GLRX	DUSP6	SCG5	ETV5	ITGB2	AKT2	PPBP	G0S2	GABRA3	IRF8	BIRC3	FGF9	DCBLD2	INHBA	TFPI	TSPAN1	ADAM8	SLPI	PRKG2	MMP11	MMP10	TMEM158	TNFAIP3	PRDM1	GALNT3	ETS1	MMP9	WNT7A	IGFBP3	SPP1	ETV1	CLEC4A	CCND2	TSPAN7	ITGBL1	EMP1	CDADC1	KIF5C	TRIB2	SDCCAG8	PCP4	CFHR2	ALDH1A2")
# KRAS_SIGNALING_DN <- c("CDH16	SPTBN2	FGFR3	NOS1	PDE6B	SIDT1	NTF3	SCN10A	TAS2R4	DTNB	HTR1D	MAST3	SLC6A3	CLDN8	TGM1	PCDHB1	THRB	YPEL1	RYR2	GDNF	CAMK1D	AMBN	LFNG	SERPINA10	ALOX12B	CALCB	FGGY	SPRR3	ATP6V1B1	EDN1	UPK3B	GAMT	PRODH	RYR1	GPR19	SLC29A3	EDN2	GPRC5C	C5	ZC2HC1C	EDAR	KCNMB1	TENT5C	STAG3	KRT4	SLC25A23	INSL5	GP1BA	KMT2D	ABCG4")
# 
# emt.e <- c("Cdh1", "Epcam", "Cldn2", "Cldn4", "Krt7", "Krt8", "Krt18", "Krt19", "Krt20", "Esrp1")
# emt.m <- c("Pdgfrb", "Zeb1", "Zeb2", "Fap", "Vim", "Cdh2", "Cdh11", "Col1a1", "Fn1", "Lef1", 
#            "Twist1", "Cfp", "Csf1r", "Dab2", "Snai1", "Snai2", "Fcgr2b","Snx20", "Spi1")}
}


#============================#
#       Musician: Resonance  #
#           Date: 2019/09/06 #
# Revised author: Resonance  #
#           Time: 2019/11/04 #
#============================#